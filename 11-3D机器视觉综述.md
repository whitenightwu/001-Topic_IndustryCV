# 3D机器视觉综述

-----------------------------------------------------------------------------------------------
## 行业现状
与2D视觉不同，3D视觉系统价值量虽然远高于2D视觉系统，但是下游需求量存在较大差异，下游应用离散化程度高，**导致大部分3D视觉企业在钻研自身软硬件产品的同时，还需要兼顾产品落地方案设计，因此许多3D视觉企业主要以产品解决方案的形式服务于下游客户，此现象在视觉引导机器人领域尤为突出。**
GGII认为，前期的方案落地对于企业技术积累以及产品推广是必不可少的，但是从行业生态发展的角度来看，**解决方案在一定程度上压缩了系统集成商的市场空间**，同时对于企业自身发展专注度有一定影响。在市场竞争日趋激烈的当下，叠加下游市场仍处于恢复阶段，3D视觉行业仍旧充满了太多的不确定性。

与此同时，3D视觉的落地应用也在不断的拓宽。对于3D视觉的应用，业内的普遍共识为“识别、测量、导引定位和检测”。譬如当前热度比较高的检测，不管是下游应用大户3C行业，还是当下的增量市场新能源、半导体，对检测的需求释放也越来越多，从单点检测开始往多工位、整线的检测铺开。

3D视觉方兴未艾，全球规模2025年将突破百亿美元
3D视觉作为机器视觉的重要发展方向，预计在2025年达到全球150亿元美元的市场规模。根据法国市场研究与战略咨询公司YOLE发布的全球3D成像和传感市场研究报告，2019年全球3D视觉感知市场规模为50亿美元，且市场规模将快速发展，预计在2025年达到150亿美元，2019-2025年CAGR达20%。。目前，消费电子占比40%，是最大的应用领域，工业紧随其后排名第二，占比达21%，其次为航天航空和汽车。YOLE预计随着汽车智能化的渗透加速，用于自动驾驶、座舱内摄像头的3D视觉将是未来五年增长最快的细分。根据高工产业研究院的数据，2025年我国机器视觉市场规模将达到415.92亿元，其中，3D视觉市场规模将达到104.35亿元。占比超过25%。



## 常见场景

- 3D视觉引导上下料/夹具引导
	- 通过3D视觉系统获取目标工件6维度空间位置信息，引导机器人进行上下料操作。
	- 适用于零配件加工及主机生产环节的上下料、料框拣选、无序拣选、动态拣选等场景。
- 3D视觉引导精密装配/装配引导
	- 3D视觉系统可获取精准的工件对位坐标，引导机器人完成装配操作，满足装配工艺高精度、低容差的苛刻要求。
	- 适用于玻璃、轮胎等总装线装配及螺丝锁付等场景
- 3D视觉引导自动轨迹规划/焊接引导
	- 通过自动规划算法，3D视觉系统可完成加工轨迹提取，无需示教即可引导机器人自动作业。
	- 适适用于涂胶、喷涂、焊接、打磨、去毛刺等场景。
- 3D视觉引导物料搬运/拆垛码垛
	- 比3D视觉引导上下料有更大的视野范围。一般都是global相机；距离1.5m以上；精度要求不如上下料。
	- 3D视觉引导机器人完成拆垛/取货、码垛/放货工作，替代人工操作，提升劳动效率。
	- 适用于原材料、半成品及成品的出入库、工位之间转运等场景。
- 3D视觉测量检测
	- 可以分为两个方面，即测量和检测。包括涂胶检测、在线测量、质量检测。
	- 进行白车身、涂装有色车身、完成车的多角度间隙、面差检测。
	- 进行异物检测、有无检测。
	- 进行目标工件动态/静态下的三维尺寸测量。
- 复合机器人3D视觉方案
	- AGV/AMR+协作机器人+3D视觉定位系统即构成复合机器人，应用于工位间零部件转运、生产线边上料等场景。
	- 轻量型3D视觉定位系统可引导协作机器人完成抓取等工作，灵活高效。



-----------------------------------------------------------------------------------------------
# 关于3D相机本体，以及知名厂商
见《3D相机选型》。

- 3D建模的核心是点云质量，即3D相机的性能。
例如，如本的相机，中心区域的成像质量更好，例如齿轮项目中只要齿轮在中心区域就一定能得到较好的点云。


-----------------------------------------------------------------------------------------------
# 算法要点
**算法库层面，一般用open3d库、PCL（Point Cloud Library，C++库）库。另外还有VCG库（专门为处理三角网格而设计的）、CGAL（计算集合算法库，大型C++的几何数据结构和算法库）。它的相关资料也是最多的。**
- PCL：pcl没有靠谱的python wrapper，唯一一个开源的已经很久没有维护了。
- Open3D：有函数但只有最基础的函数，不如PCL库的全面。
- Pyvista
- Pymesh：是一个用于处理和生成3D网格的Python库。是一个专门用于处理三角形网格的Python库，可以读取多种格式的三维模型文件，包括PLY文件。PyMesh提供了一些函数可以计算三角形网格的SDF，以及生成离散化的体积网格（voxel grid）。
- VTK
- Trimesh：三角表面。Trimesh是一个流行的面向几何建模的Python库，可以读入多种格式的三维模型文件，包括PLY文件。Trimesh提供了一些函数可以计算三角形网格的SDF，以及创建体积网格（voxel grid）。


**视觉软件层面，一般用Halcon。**

## 整体算法方案
根据具体的应用需求灵活选择，可针对标准的细分行业形成相对通用的解决方案。
3D视觉实际使用时，一定是先粗配准，再精配准。
1、获取点云​
2、点云预处理（点云滤波、点云降采样或增采样、点云分割、AI辅助分割等等）​
3.1、几何参数提取目标信息（最小box、圆环，圆柱拟合，空间圆拟合、圆锥拟合等等）​
3.2、点云匹配的方法获取目标信息;粗配准（FPFH、3DS、4P、PPF、3P等等）+精配准（ICP、NICP等等）​
3.3、根据点云信息PCA分析、点云特征匹配、点云切片，切片规则---生成机械臂行走路径用于（打磨、涂胶、喷涂等应用）--落地需要结合细分行业和具体的工艺要求​


ICP配准和彩色点云配准都被称为局部点云配准方法，因为他们都依赖一个粗糙的对齐作为初始化。本篇教程将会展现另一种被称为全局配准的配准方法.这种系列的算法不要求一个初始化的对齐,通常会输出一个没那么精准的对齐结果,并且使用该结果作为局部配准的初始化.

## 3D平面估计
定义：有较大平面的物料
解决方案的流程：
1. 2D物料分割
2. 3D点云预处理/分割
3. 点云平面拟合


## 3D匹配
简单形状用形状匹配；
复杂形状用点云匹配；


## 6D位姿匹配算法
平面拟合
3D模板匹配，例如3Dlinemod。
CPPF
PPF



-----------------------------------------------------------------------------------------------
## HALCON中提供的3D匹配
对于shape-based（基于形状）的3D匹配，从一个3D CAD模型中产生一个3D形状模型，CAD模型必须是HALCON支持的格式之一。3D形状模型由3D物体从不同视角下得到的2D映射组成。类似于2D结构的基于形状的匹配，3D形状模型被用来在一张图像中识别物体的实例，但是这里，每一个实例的3D位姿被返回，而不是2D的位置，方向和尺度。
对于surface-based（基于表面）的3D匹配，一个表面模型要么产生于一个符合支持格式的CAD模型，要么产生于一个OM3格式的3D物体模型，后者可以利用3D重构的方法从图像中获得，例如立体视觉。相比于基于形状的3D匹配，物体并不在图像中进行搜索，而是在3D场景中。就像基于形状的3D匹配，基于表面的3D匹配返回定位到每一个物体实例的3D位姿。
Deformable surface-based可变性的基于表面的3D匹配类似于上面提到的基于表面的3D匹配，但是其也可以找到变形的3D物体。另外，它允许去定义一些针对参考物体特定的3D点，例如抓取点，这些点也被称为参考点。一旦这个（变形的）3D物体已经被找到，参考点的位置也将适应被发现物体的变形，例如抓取变形的物体。


